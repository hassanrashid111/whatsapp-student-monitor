<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>منصة أثر التعليمية | لوحة تحكم المشرف</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx-bundle.min.js"></script>
    <script>
      // كود احتياطي للتأكد من تحميل المكتبة
      if(typeof XLSX === 'undefined') {
          console.warn("جاري محاولة تحميل بديلة...");
          document.write('<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"><\/script>');
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>

  <body>
    <div id="login-view" class="login-container">
      <div class="login-card">
        <div class="login-icon">
          <i class="fa-solid fa-mosque"></i>
        </div>
        <h1>صفحة تسجيل الدخول</h1>
        <p class="subtitle">لوحة تحكم المشرف - الدورة الإسلامية عبر الإنترنت</p>

        <form id="login-form">
          <div class="input-group">
            <label>اسم المستخدم</label>
            <div class="input-wrapper">
              <input
                type="text"
                id="username"
                placeholder="أدخل اسم المستخدم"
                required
              />
              <i class="fa-solid fa-user"></i>
            </div>
          </div>
          <div class="input-group">
            <label>كلمة المرور</label>
            <div class="input-wrapper">
              <input
                type="password"
                id="password"
                placeholder="أدخل كلمة المرور"
                required
              />
              <i class="fa-solid fa-lock"></i>
            </div>
          </div>

          <button type="submit" class="btn-login">
            تسجيل الدخول <i class="fa-solid fa-arrow-right-to-bracket"></i>
          </button>
        </form>
        <div class="copyright">© 2025 منصة التعليم الإسلامي المتقدمة</div>
      </div>
    </div>

    <div id="dashboard-view" class="dashboard-container" style="display: none">
      <header class="main-header">
        <div class="header-right">
          <div class="logo-area">
            <i class="fa-solid fa-mosque logo-icon"></i>
            <div>
              <h2>منصة أثر التعليمية</h2>
              <span>لوحة تحكم مشرف المتابعة</span>
            </div>
          </div>
        </div>
  

        
            <div class="header-left">
        <a href="/habits" class="btn-action" style="text-decoration: none;" title="محاسبة النفس">
            <i class="fa-solid fa-heart-pulse"></i>
        </a>
        
        <button class="btn-action" onclick="window.app.openImport()" title="استيراد سريع">
            <i class="fa-solid fa-paste"></i> استيراد
        </button>

        <button class="btn-action" onclick="window.app.addStudent()" title="إضافة طالب">
            <i class="fa-solid fa-user-plus"></i> طالب
        </button>

        <button class="btn-action" onclick="window.app.addLecture()" title="إضافة محاضرة">
            <i class="fa-solid fa-plus-circle"></i> محاضرة
        </button>

        <div class="dropdown">
            <button class="btn-action dropbtn">
                <i class="fa-solid fa-gear"></i> أدوات النظام <i class="fa-solid fa-caret-down"></i>
            </button>
            <div class="dropdown-content">
                <a onclick="window.app.exportData()"><i class="fa-solid fa-file-excel"></i> تصدير Excel</a>
                <a onclick="window.app.getReport()"><i class="fa-solid fa-file-lines"></i> تقرير نصي</a>
                <a onclick="window.app.backupData()"><i class="fa-solid fa-download"></i> حفظ نسخة</a>
                <a onclick="document.getElementById('restore-input').click()">
                    <i class="fa-solid fa-upload"></i> استرجاع نسخة
                </a>
                <a onclick="window.app.resetMessages()" style="color: #e67e22;">
                    <i class="fa-solid fa-rotate-left"></i> تصفير الرسائل
                </a>
                <a onclick="window.app.clearAllData()" style="color: #e74c3c;">
                    <i class="fa-solid fa-trash-can"></i> تصفير النظام
                </a>
            </div>
        </div>
        
        <input type="file" id="restore-input" style="display: none;" onchange="window.app.restoreData(this)" accept=".json">

        <button class="btn-action" onclick="window.app.toggleTheme()" title="الوضع الليلي">
            <i class="fa-solid fa-moon"></i>
        </button>
        <button class="btn-logout" onclick="window.app.logout()" title="خروج">
            <i class="fa-solid fa-arrow-right-from-bracket"></i>
        </button>
    </div>
      </header>

      <main class="main-content">
        <div class="page-title-area">
          <h1>سجل متابعة الطلاب</h1>
          <p>إدارة الحضور والغياب وإرسال رسائل المتابعة الدورية</p>
          <div class="filters-container" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); display: flex; gap: 15px; align-items: center;">
            <div class="search-box" style="position: relative;">
               <i class="fa-solid fa-magnifying-glass" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #aaa;"></i>
               <input type="text" id="searchInput" onkeyup="window.app.search()" placeholder="بحث بالاسم أو الهاتف..." style="padding: 8px 30px 8px 10px; border: 1px solid #ddd; border-radius: 20px; outline: none;">
            </div>
          </div>
        </div>

        <div class="table-card">
          <div class="table-responsive">
            <table id="students-table">
              <thead><tr id="table-header-row"></tr></thead>
              <tbody id="students-body"></tbody>
            </table>
          </div>
          <div class="pagination">
            <span>جاري التحميل...</span>
          </div>
        </div>

        <div class="bottom-grid">
          <div class="card summary-card">
            <div class="card-header">
              <h3>ملخص اليوم</h3>
              <p class="date-display">--</p>
            </div>
            <div class="stats-list">
              <div class="stat-item total"><span>العدد الكلي</span><strong id="stat-total">0</strong></div>
              <div class="stat-item absence"><span>الغياب اليوم</span><strong id="stat-absence">0</strong></div>
              <div class="stat-item remaining"><span>المحاضرات المتبقية</span><strong id="stat-remaining">0</strong></div>
            </div>
            <div class="quote-box">
              <i class="fa-solid fa-quote-right quote-icon"></i>
              <p>جاري تحميل الحديث...</p>
            </div>
          </div>

          <div class="card messaging-card">
            <div class="card-header-row">
              <div class="icon-sq"><i class="fa-solid fa-envelope-open-text"></i></div>
              <div>
                <h3>رسالة المتابعة لليوم</h3>
                <p>قم بصياغة الرسالة التي سيتم إرسالها للطلاب المتغيبين</p>
              </div>
            </div>

            <div class="toggle-control">
              <label class="switch">
                <input type="checkbox" id="include-name-toggle" checked>
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">إدراج اسم الطالب في بداية الرسالة</span>
            </div>
            <div class="message-body">
              <textarea id="message-text" placeholder="قم بصياغة الرسالة التي سيتم إرسالها للطلاب المتغيبين"></textarea>
              <div class="action-row">
                <button class="btn-whatsapp" onclick="window.app.sendMessages()">
                  إرسال الرسالة عبر واتساب <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>

      <footer class="main-footer">
        <h3>وَقُل رَّبِّ زِدْنِي عِلْمًا</h3>
        <p>© 2025 | Made with ❤️ and Code by Eng Hassan Rashid</p>
      </footer>
    </div>

    <div id="notes-modal" class="modal-overlay" style="display: none;">
      <div class="modal-card profile-card-wide">
        <div class="modal-header">
          <div class="student-info-header">
            <div class="modal-avatar" id="modal-avatar">A</div>
            <div>
              <h2 id="modal-student-name">اسم الطالب</h2>
              <span class="modal-subtitle" id="modal-student-phone">01xxxxxxxxx</span>
            </div>
          </div>
          <button class="close-modal" onclick="window.app.closeNotes()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <div class="modal-body-grid">
            <div class="profile-main">
                <div class="chart-container">
                    <h3><i class="fa-solid fa-chart-line"></i> مؤشر الأداء التراكمي</h3>
                    <canvas id="performanceChart"></canvas>
                </div>
                
                <div class="notes-section">
                    <label for="student-notes"><i class="fa-solid fa-pen-to-square"></i> الملاحظات التربوية:</label>
                    <textarea id="student-notes" placeholder="اكتب ملاحظاتك عن الطالب هنا..."></textarea>
                    <button class="btn-save-notes" onclick="window.app.saveNotes()">
                        <i class="fa-solid fa-floppy-disk"></i> حفظ الملاحظات
                    </button>
                </div>
            </div>

            <div class="profile-sidebar">
                <h3><i class="fa-solid fa-clock-rotate-left"></i> سجل الحضور</h3>
                <div class="history-list" id="attendance-history">
                    </div>
            </div>
        </div>
      </div>
    </div> 
    <div id="context-menu" class="context-menu" style="display: none;">
  <div class="menu-header">تحديد حالة الطالب</div>
  <ul>
    <li class="separator"></li>

    <li onclick="window.app.manualStatus('replied')">
        <i class="fa-solid fa-comment-dots" style="color:#f39c12"></i> رد ولم يختبر
    </li>
    <li onclick="window.app.manualStatus(0)"><i class="fa-solid fa-crown" style="color:#f1c40f"></i> تسليم السبت (100%)</li>
    <li onclick="window.app.manualStatus(1)"><i class="fa-solid fa-circle-check" style="color:#2ecc71"></i> تسليم الأحد (90%)</li>
    <li onclick="window.app.manualStatus(2)"><i class="fa-solid fa-circle-check" style="color:#2ecc71"></i> تسليم الاثنين (80%)</li>
    <li onclick="window.app.manualStatus(3)"><i class="fa-solid fa-circle-check" style="color:#27ae60"></i> تسليم الثلاثاء (70%)</li>
    <li onclick="window.app.manualStatus(4)"><i class="fa-solid fa-circle-check" style="color:#27ae60"></i> تسليم الأربعاء (60%)</li>
    <li onclick="window.app.manualStatus(5)"><i class="fa-solid fa-circle-check" style="color:#f39c12"></i> تسليم الخميس (50%)</li>
    <li onclick="window.app.manualStatus(6)"><i class="fa-solid fa-circle-check" style="color:#e67e22"></i> تسليم الجمعة (40%)</li>
    <li class="separator"></li>
    <li onclick="window.app.manualStatus(10)"><i class="fa-solid fa-clock" style="color:#e74c3c"></i> تأخير أسبوع (30%)</li>
    <li onclick="window.app.manualStatus(17)"><i class="fa-solid fa-clock" style="color:#c0392b"></i> تأخير أسبوعين (20%)</li>
    <li class="separator"></li>
    <li onclick="window.app.manualStatus(-1)"><i class="fa-solid fa-trash"></i> إلغاء / غياب</li>
  </ul>
</div>


<div id="import-modal" class="modal-overlay" style="display: none;">
  <div class="modal-card">
    <div class="modal-header">
      <h3><i class="fa-solid fa-users"></i> استيراد سريع</h3>
      <button class="close-modal" onclick="window.app.closeImport()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <label>الصق القائمة هنا (كل طالب في سطر):</label>
      <p style="font-size:0.8rem; color:#666; margin-bottom:5px;">يمكنك لصق الأسماء، أو أرقام الهواتف فقط.</p>
      <textarea id="import-text" placeholder="010xxxxxxx
011xxxxxxx
..." style="height: 200px; width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn-save-notes" onclick="window.app.saveImport()">
        <i class="fa-solid fa-file-import"></i> بدء الاستيراد
      </button>
    </div>
  </div>
</div>

<div id="edit-student-modal" class="modal-overlay" style="display: none;">
  <div class="modal-card" style="max-width: 400px;">
    <div class="modal-header">
      <h3>تعديل بيانات الطالب</h3>
      <button class="close-modal" onclick="document.getElementById('edit-student-modal').style.display='none'"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="input-group" style="text-align: right;">
        <label>اسم الطالب</label>
        <input type="text" id="edit-name" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px;">
      </div>
      <div class="input-group" style="text-align: right; margin-top:10px;">
        <label>رقم الهاتف</label>
        <input type="text" id="edit-phone" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px;">
      </div>
      <input type="hidden" id="edit-id">
    </div>
    <div class="modal-footer">
      <button class="btn-save-notes" onclick="window.app.saveEditStudent()">
        <i class="fa-solid fa-floppy-disk"></i> حفظ التعديلات
      </button>
    </div>
  </div>
</div>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
  <button onclick="window.scrollTo({top: 0, behavior: 'smooth'});" id="scrollTopBtn" style="display:none; position:fixed; bottom:20px; left:20px; background:#1A5D3A; color:white; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.3); z-index:100;">
      <i class="fa-solid fa-arrow-up"></i>
  </button>

  <script>
      // إظهار الزر عند النزول
      window.onscroll = function() {
          const btn = document.getElementById('scrollTopBtn');
          if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
              btn.style.display = "block";
          } else {
              btn.style.display = "none";
          }
      };
  </script>
    
  </body>
</html>